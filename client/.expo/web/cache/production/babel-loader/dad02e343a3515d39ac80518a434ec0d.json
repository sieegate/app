{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/defineProperty\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import io from\"socket.io-client\";import axios from\"axios\";import{apiConfig}from\"../config\";import{showOverlay}from\"../actions/overlayAction\";export var devMiddleware=function devMiddleware(store){return function(next){return function(action){console.log(action.type);return next(action);};};};export var socketMiddleware=function socketMiddleware(){var socket;return function(store){return function(next){return function(action){var _action$type;if(!socket&&store.getState().auth.isLoggedIn){console.log(\"socket somehow disconnected\");}if(action.type===\"REQUEST_LOG_IN:SUCCESS\"||action.type===\"REQUEST_SIGN_UP:SUCCESS\"||action.type===\"REQUEST_VERIFY_TOKEN:SUCCESS\"){var token=action.data.token;socket=io(apiConfig.baseUrl.replace(\"/api/\",\"\"),{forceNode:true,transportOptions:{polling:{extraHeaders:{\"Access-Control-Allow-Origin\":\"*\",authorization:token}}}});socket.on(\"connected\",function(data){console.log(\"Socket connected\");});socket.on(\"unauthorized\",function(data){console.log(\"Socket disconnected\");});socket.on(\"authenticated\",function(data){console.log(\"Socket authenticated\");});socket.on(\"private-conversation\",function(data){store.dispatch(_objectSpread({type:\"RECEIVE_PRIVATE_CONVERSATION\"},data,{receivedAt:new Date()}));});socket.on(\"private-conversation-ack\",function(data){store.dispatch(_objectSpread({type:\"PRIVATE_CONVERSATION_ACK\"},data,{receivedAt:new Date()}));});socket.on(\"private-message\",function(data){store.dispatch(_objectSpread({type:\"RECEIVE_PRIVATE_MESSAGE\"},data,{receivedAt:new Date()}));});socket.on(\"private-message-ack\",function(data){store.dispatch(_objectSpread({type:\"PRIVATE_MESSAGE_ACK\"},data,{receivedAt:new Date()}));});}if(((_action$type=action.type)==null?void 0:_action$type.substring(0,6))===\"SOCKET\"){socket.emit(action.event,action.payload);}if(action.type===\"REQUEST_LOG_OUT:SUCCESS\"){socket.disconnect();console.log(\"socket disconnected\");}return next(action);};};};};export var axiosMiddleware=function axiosMiddleware(store){return function(next){return function(action){var _action$type2,_action$type3;if(((_action$type2=action.type)==null?void 0:_action$type2.substring(0,7))===\"REQUEST\"&&((_action$type3=action.type)==null?void 0:_action$type3.includes(\":\"))===false){var https;if(action.type.substring(0,14)===\"REQUEST_UPLOAD\"){https=axios.create({baseURL:apiConfig.baseUrl,timeout:3000,headers:{accept:\"application/json\",\"Access-Control-Allow-Origin\":\"*\",\"Content-Type\":\"multipart/form-data\",Authorization:\"Bearer \"+store.getState().auth.token}});}else{https=axios.create({baseURL:apiConfig.baseUrl,timeout:3000,headers:{\"Access-Control-Allow-Origin\":\"*\",\"Content-Type\":\"application/json\",Authorization:\"Bearer \"+store.getState().auth.token}});}var request=new Promise(function(resolve,reject){var res;switch(action.method){case\"GET\":res=https.get(action.route);return resolve(res);case\"POST\":res=https.post(action.route,action.payload);return resolve(res);case\"DELETE\":res=https.delete(action.route,action.payload);return resolve(res);case\"PATCH\":res=https.patch(action.route,action.payload);return resolve(res);default:return;}});request.then(function(res){if(action.successNotification){store.dispatch(showOverlay({timeout:3000,redirect:action.successNotification.redirect,callbacks:action.successNotification.callbacks,notification:{variant:\"success\",message:action.successNotification.message}}));}return store.dispatch({type:action.type+\":SUCCESS\",data:res.data,receivedAt:new Date()});}).catch(function(err){var _err$response;console.log(err);if(action.errorNotification||((_err$response=err.response)==null?void 0:_err$response.data.forceReconnect)===true){var _err$response2,_err$response3,_err$response4;store.dispatch(showOverlay({timeout:3000,redirect:((_err$response2=err.response)==null?void 0:_err$response2.data.forceReconnect)&&\"Auth\",callbacks:((_err$response3=err.response)==null?void 0:_err$response3.data.forceReconnect)&&[\"REQUEST_LOG_OUT:SUCCESS\"],notification:{variant:\"error\",message:((_err$response4=err.response)==null?void 0:_err$response4.data.message)||\"Cela n'a pas marché...\"}}));}return store.dispatch({type:action.type+\":ERROR\",error:err,receivedAt:new Date()});});return next(action);}else{return next(action);}};};};","map":{"version":3,"sources":["/home/gaetan/Documents/GATE/app/client/src/store/reduxMiddlewares.js"],"names":["io","axios","apiConfig","showOverlay","devMiddleware","store","next","action","console","log","type","socketMiddleware","socket","getState","auth","isLoggedIn","token","data","baseUrl","replace","forceNode","transportOptions","polling","extraHeaders","authorization","on","dispatch","receivedAt","Date","substring","emit","event","payload","disconnect","axiosMiddleware","includes","https","create","baseURL","timeout","headers","accept","Authorization","request","Promise","resolve","reject","res","method","get","route","post","delete","patch","then","successNotification","redirect","callbacks","notification","variant","message","catch","err","errorNotification","response","forceReconnect","error"],"mappings":"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","sourcesContent":["import io from \"socket.io-client\";\nimport axios from \"axios\";\nimport { apiConfig } from \"../config\";\nimport { showOverlay } from \"../actions/overlayAction\";\n\nexport const devMiddleware = (store) => (next) => (action) => {\n  console.log(action.type);\n  return next(action);\n};\n\nexport const socketMiddleware = () => {\n  let socket;\n  return (store) => (next) => (action) => {\n    if (!socket && store.getState().auth.isLoggedIn) {\n      console.log(\"socket somehow disconnected\");\n    }\n    if (\n      action.type === \"REQUEST_LOG_IN:SUCCESS\" ||\n      action.type === \"REQUEST_SIGN_UP:SUCCESS\" ||\n      action.type === \"REQUEST_VERIFY_TOKEN:SUCCESS\"\n    ) {\n      const { token } = action.data;\n      socket = io(apiConfig.baseUrl.replace(\"/api/\", \"\"), {\n        forceNode: true,\n        transportOptions: {\n          polling: {\n            extraHeaders: {\n              \"Access-Control-Allow-Origin\": \"*\",\n              authorization: token,\n            },\n          },\n        },\n      });\n      socket.on(\"connected\", (data) => {\n        console.log(\"Socket connected\");\n      });\n      socket.on(\"unauthorized\", (data) => {\n        console.log(\"Socket disconnected\");\n      });\n      socket.on(\"authenticated\", (data) => {\n        console.log(\"Socket authenticated\");\n      });\n      socket.on(\"private-conversation\", (data) => {\n        store.dispatch({\n          type: \"RECEIVE_PRIVATE_CONVERSATION\",\n          ...data,\n          receivedAt: new Date(),\n        });\n      });\n      socket.on(\"private-conversation-ack\", (data) => {\n        store.dispatch({\n          type: \"PRIVATE_CONVERSATION_ACK\",\n          ...data,\n          receivedAt: new Date(),\n        });\n      });\n      socket.on(\"private-message\", (data) => {\n        store.dispatch({\n          type: \"RECEIVE_PRIVATE_MESSAGE\",\n          ...data,\n          receivedAt: new Date(),\n        });\n      });\n      socket.on(\"private-message-ack\", (data) => {\n        store.dispatch({\n          type: \"PRIVATE_MESSAGE_ACK\",\n          ...data,\n          receivedAt: new Date(),\n        });\n      });\n    }\n    if (action.type?.substring(0, 6) === \"SOCKET\") {\n      socket.emit(action.event, action.payload);\n    }\n    if (action.type === \"REQUEST_LOG_OUT:SUCCESS\") {\n      socket.disconnect();\n      console.log(\"socket disconnected\");\n    }\n\n    return next(action);\n  };\n};\n\nexport const axiosMiddleware = (store) => (next) => (action) => {\n  if (\n    action.type?.substring(0, 7) === \"REQUEST\" &&\n    action.type?.includes(\":\") === false\n  ) {\n    let https;\n    if (action.type.substring(0, 14) === \"REQUEST_UPLOAD\") {\n      https = axios.create({\n        baseURL: apiConfig.baseUrl,\n        timeout: 3000,\n        headers: {\n          accept: \"application/json\",\n          \"Access-Control-Allow-Origin\": \"*\",\n          \"Content-Type\": \"multipart/form-data\",\n          Authorization: `Bearer ${store.getState().auth.token}`,\n        },\n      });\n    } else {\n      https = axios.create({\n        baseURL: apiConfig.baseUrl,\n        timeout: 3000,\n        headers: {\n          \"Access-Control-Allow-Origin\": \"*\",\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${store.getState().auth.token}`,\n        },\n      });\n    }\n    const request = new Promise(function (resolve, reject) {\n      let res;\n\n      switch (action.method) {\n        case \"GET\":\n          res = https.get(action.route);\n          return resolve(res);\n        case \"POST\":\n          res = https.post(action.route, action.payload);\n          return resolve(res);\n        case \"DELETE\":\n          res = https.delete(action.route, action.payload);\n          return resolve(res);\n        case \"PATCH\":\n          res = https.patch(action.route, action.payload);\n          return resolve(res);\n        default:\n          return;\n      }\n    });\n    request\n      .then((res) => {\n        if (action.successNotification) {\n          store.dispatch(\n            showOverlay({\n              timeout: 3000,\n              redirect: action.successNotification.redirect,\n              callbacks: action.successNotification.callbacks,\n              notification: {\n                variant: \"success\",\n                message: action.successNotification.message,\n              },\n            })\n          );\n        }\n        return store.dispatch({\n          type: `${action.type}:SUCCESS`,\n          data: res.data,\n          receivedAt: new Date(),\n        });\n      })\n      .catch((err) => {\n        console.log(err);\n        if (\n          action.errorNotification ||\n          err.response?.data.forceReconnect === true\n        ) {\n          store.dispatch(\n            showOverlay({\n              timeout: 3000,\n              redirect: err.response?.data.forceReconnect && \"Auth\",\n              callbacks: err.response?.data.forceReconnect && [\n                \"REQUEST_LOG_OUT:SUCCESS\",\n              ],\n              notification: {\n                variant: \"error\",\n                message: err.response?.data.message || \"Cela n'a pas marché...\",\n              },\n            })\n          );\n        }\n        return store.dispatch({\n          type: `${action.type}:ERROR`,\n          error: err,\n          receivedAt: new Date(),\n        });\n      });\n\n    return next(action);\n  } else {\n    return next(action);\n  }\n};\n"]},"metadata":{},"sourceType":"module"}